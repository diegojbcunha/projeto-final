<div class="trainings-container">
  <h2 class="title">Corporate Training Courses</h2>

  <div class="actions-bar" *ngIf="isAdmin">
    <button class="add-btn" (click)="addNew()">+ Add New Course</button>
  </div>

  <div class="themes-section" *ngFor="let theme of themes">
    <h3 class="theme-title">{{ theme }}</h3>
    <div class="courses-grid">
      <div class="course-card" *ngFor="let course of getCoursesForTheme(theme); trackBy: trackById">
        <img [src]="course.image" alt="{{ course.title }}" class="course-image" />
        <div class="course-info">
          <h4>{{ course.title }}</h4>
          <p class="description">{{ course.description }}</p>
          <div class="course-details">
            <span class="duration"> {{ course.duration }}h</span>
            <span class="modules"> {{ course.modules }} modules</span>
            <span class="status" [class.active]="course.status === 'Active'" [class.upcoming]="course.status === 'Upcoming'">
              {{ course.status }}
            </span>
          </div>
          <div class="completion" *ngIf="course.completionRate > 0">
            <span>Progress: {{ course.completionRate }}% completed</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="course.completionRate"></div>
            </div>
          </div>
          <p class="audience">Audience: {{ course.targetAudience }}</p>
          <div class="admin-actions" *ngIf="isAdmin">
            <button (click)="editCourse(course)">Edit</button>
            <button class="delete" (click)="deleteCourse(course.id)" *ngIf="isAdmin">Delete</button>
          </div>
          
          <!-- Button to open modules modal -->
          <div class="modules-toggle">
            <button 
              class="toggle-modules-btn" 
              (click)="openModulesModal(course)">
              View Modules
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modules Modal -->
  <div *ngIf="showModulesModal()" class="modules-modal modules-modal-overlay" (click)="onModulesModalClick($event)">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ selectedCourse?.title }} - Modules</h3>
        <button type="button" class="close-modal" (click)="closeModulesModal()" aria-label="Close modal">
          Ã—
        </button>
      </div>
      
      <div class="modal-body">
        <div class="course-info-modal">
          <img [src]="selectedCourse?.image" [alt]="selectedCourse?.title" class="course-thumbnail" />
          <div class="course-details-modal">
            <p class="course-description">{{ selectedCourse?.description }}</p>
            <div class="course-meta">
              <span class="duration"> {{ selectedCourse?.duration }}h</span>
              <span class="modules"> {{ selectedCourse?.modules }} modules</span>
              <span class="completion">{{ selectedCourse?.completionRate }}% complete</span>
            </div>
          </div>
        </div>
        
        <div class="modules-header">
          <h4>Course Modules ({{ selectedCourseModules.length }} modules, {{ getTotalDuration(selectedCourseModules) }}h total)</h4>
        </div>
        
        <div class="modules-list">
          <div class="course-module-item" *ngFor="let module of selectedCourseModules; let i = index">
            <div class="module-info">
              <div class="module-icon" [class]="module.type">
                {{ module.type === 'video' ? '' :
                   module.type === 'quiz' ? '' :
                   module.type === 'reading' ? '' :
                   module.type === 'assignment' ? '' :
                   module.type === 'presentation' ? '' :
                   'ðŸ“„' }}
              </div>
              <div class="module-details">
                <div class="module-title">{{ module.title }}</div>
                <div class="module-meta">
                  <span class="module-type">{{ getTypeLabel(module.type) }}</span>
                  <span class="module-duration">{{ module.duration }} min</span>
                </div>
              </div>
            </div>
            
            <div class="module-status">
              <span class="status-badge" [class]="getModuleStatus(module).toLowerCase()">
                {{ getModuleStatus(module) }}
              </span>
              <button 
                class="start-module-btn"
                (click)="startModule(module)"
                [disabled]="getModuleStatus(module) === 'Locked'">
                {{ module.isCompleted ? 'Review' : 'Start' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showForm()" class="form-card" (click)="onModalClick($event)">
    <div class="form-content">
      <div class="form-header">
        <h3>{{ editMode() ? 'Edit Course' : 'Add New Course' }}</h3>
        <button type="button" class="close-modal" (click)="cancel()" aria-label="Close modal">
          Ã—
        </button>
      </div>

      <form #courseForm="ngForm" (ngSubmit)="saveCourse()">
        <input
          type="text"
          [(ngModel)]="currentCourse.title"
          name="title"
          placeholder="Title"
          required
          #title="ngModel"
          (keydown)="onKeyDown($event)"
        />

        <textarea
          [(ngModel)]="currentCourse.description"
          name="description"
          placeholder="Description"
          required
          #description="ngModel"
          rows="3">
        </textarea>

        <input
          type="number"
          [(ngModel)]="currentCourse.duration"
          name="duration"
          placeholder="Duration (hours)"
          min="0.5"
          step="0.5"
          required
          #duration="ngModel"
        />

        <input
          type="number"
          [(ngModel)]="currentCourse.modules"
          name="modules"
          placeholder="Number of modules"
          min="1"
          required
          #modules="ngModel"
        />

        <input
          type="text"
          [(ngModel)]="currentCourse.image"
          name="image"
          placeholder="Image URL"
          required
          #image="ngModel"
        />

        <select
          [(ngModel)]="currentCourse.status"
          name="status"
          required
          #status="ngModel">
          <option value="Active">Active</option>
          <option value="Upcoming">Upcoming</option>
        </select>

        <input
          type="text"
          [(ngModel)]="currentCourse.targetAudience"
          name="targetAudience"
          placeholder="Target Audience"
          required
          #targetAudience="ngModel"
        />

        <select
          [(ngModel)]="currentCourse.theme"
          name="theme"
          required
          #theme="ngModel">
          <option *ngFor="let theme of themes" [value]="theme">{{ theme }}</option>
        </select>

        <!-- Modules Management -->
        <div class="modules-section">
          <h4>Course Modules</h4>

          <!-- Existing modules -->
          <div class="existing-modules">
            <div class="form-module-item" *ngFor="let module of currentCourse.courseModules; let i = index">
              <input type="text" [(ngModel)]="module.title" name="title{{i}}" placeholder="Module Title" />
              <select [(ngModel)]="module.type" name="type{{i}}">
                <option value="video">Video</option>
                <option value="quiz">Quiz</option>
                <option value="reading">Reading</option>
                <option value="assignment">Assignment</option>
                <option value="presentation">Presentation</option>
              </select>
              <input type="number" [(ngModel)]="module.duration" name="duration{{i}}" placeholder="Duration (min)" />
              <button type="button" class="remove-module-btn" (click)="removeModule(i)">Ã—</button>
            </div>
          </div>

          <!-- Add module -->
          <div class="add-module">
            <button type="button" class="add-module-btn" (click)="addNewModule()">+ Add Module</button>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" [disabled]="courseForm.invalid" class="save-btn">Save</button>
          <button type="button" class="cancel-btn" (click)="cancel()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>